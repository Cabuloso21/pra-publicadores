<div id="saida"></div>
<div id="status-pagamento" style="margin-top:10px; font-weight:bold;"></div>

<!-- Modal do checkout Mercado Pago -->
<div id="mp-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
  <div id="mp-container" style="background:white; padding:20px; border-radius:10px; width:400px; max-width:90%; position:relative;">
    <button id="mp-close" style="position:absolute; top:10px; right:10px; cursor:pointer;">‚úñÔ∏è</button>
    <div id="mp-checkout"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// üîë Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCqkWODpY54YGrvqPVMABK_k_ZJLo1KXMA",
  authDomain: "teste-cfe69.firebaseapp.com",
  databaseURL: "https://teste-cfe69-default-rtdb.firebaseio.com",
  projectId: "teste-cfe69",
  storageBucket: "teste-cfe69.firebasestorage.app",
  messagingSenderId: "646579509123",
  appId: "1:646579509123:web:5565c595f322cf3ba308b6",
  measurementId: "G-81YQG8L41X"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const saida = document.getElementById("saida");
const statusDiv = document.getElementById("status-pagamento");
const mpModal = document.getElementById("mp-modal");
const mpClose = document.getElementById("mp-close");
const mpCheckoutDiv = document.getElementById("mp-checkout");

const usuarioId = "usuario123"; // ID do usu√°rio logado ou identificador √∫nico

// ===================== Formul√°rio bloqueado =====================
const form = document.createElement("form");
form.id = "formularioExemplo";

const campoNome = document.createElement("input");
campoNome.placeholder = "Nome";
campoNome.disabled = true;

const campoProduto = document.createElement("input");
campoProduto.placeholder = "Produto";
campoProduto.disabled = true;

const btnEnviar = document.createElement("button");
btnEnviar.textContent = "Enviar formul√°rio";
btnEnviar.type = "submit";
btnEnviar.disabled = true;

form.appendChild(campoNome);
form.appendChild(campoProduto);
form.appendChild(btnEnviar);

form.addEventListener("submit", e => {
  e.preventDefault();
  alert("Formul√°rio enviado com sucesso!");
  form.reset();
});

saida.appendChild(form);

// ===================== Observa pagamentos no Firestore =====================
onSnapshot(doc(db, "pagamentos", usuarioId), docSnap => {
  if(docSnap.exists()){
    const data = docSnap.data();
    if(data.aprovado){
      desbloquearFormulario(form.id);
      mpModal.style.display = "none";
    } else {
      statusDiv.textContent = "‚è≥ Pagamento pendente...";
      form.querySelectorAll("input,button").forEach(el => el.disabled = true);
    }
  }
});

// ===================== Bot√µes de pagamento =====================
const btnPix = document.createElement("button");
btnPix.textContent = "üí≥ Pagar via Pix";
btnPix.style.marginRight = "10px";
btnPix.style.padding = "10px 15px";
btnPix.style.cursor = "pointer";

const btnMP = document.createElement("button");
btnMP.textContent = "üíµ Pagar via Mercado Pago";
btnMP.style.padding = "10px 15px";
btnMP.style.cursor = "pointer";

saida.appendChild(btnPix);
saida.appendChild(btnMP);

// ===================== Bot√£o Pix =====================
btnPix.addEventListener("click", async () => {
  const chavePix = "00020126580014BR.GOV.BCB.PIX0136e7da7da8-fc3a-4616-80d1-c4d1567e166752040000530398654044.005802BR5925Jamily Allyson Menezes Si6009SAO PAULO62140510wgAmrOxuDA6304E413";
  saida.innerHTML += `<p>üí≥ Copie o c√≥digo Pix abaixo e realize o pagamento:</p>
                      <input value="${chavePix}" readonly style="width:80%; padding:10px">`;
  statusDiv.textContent = "‚è≥ Aguardando pagamento via Pix...";

  // Cria documento Firestore para Pix
  await setDoc(doc(db, "pagamentos", usuarioId), { aprovado: false, criadoEm: serverTimestamp() }, { merge: true });

  // Observa altera√ß√£o
  onSnapshot(doc(db, "pagamentos", usuarioId), docSnap => {
    if(docSnap.exists() && docSnap.data().aprovado){
      desbloquearFormulario(form.id);
      statusDiv.textContent = "‚úÖ Pagamento via Pix aprovado! Formul√°rio desbloqueado.";
    }
  });
});

// ===================== Bot√£o Mercado Pago =====================
mpClose.addEventListener("click", () => mpModal.style.display = "none");

btnMP.addEventListener("click", async () => {
  mpModal.style.display = "flex";
  statusDiv.textContent = "üîî Criando pagamento Mercado Pago...";

  // Cria documento Firestore
  await setDoc(doc(db, "pagamentos", usuarioId), { aprovado: false, criadoEm: serverTimestamp() }, { merge: true });

  // Chama backend Node.js para gerar preference_id
  const res = await fetch("http://localhost:3000/criar-pagamento", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ usuario: usuarioId, valor: 50, descricao: "Acesso Premium" })
  });
  const data = await res.json(); // data.id = preference_id

  // Carrega SDK Mercado Pago
  if(!window.MercadoPago){
    const mpScript = document.createElement("script");
    mpScript.src = "https://sdk.mercadopago.com/js/v2";
    mpScript.onload = () => renderCheckout(data.id);
    document.body.appendChild(mpScript);
  } else {
    renderCheckout(data.id);
  }
});

// ===================== Renderiza checkout Mercado Pago =====================
function renderCheckout(preferenceId){
  const mp = new MercadoPago("TEST-58386062-5f31-4b3c-8ea9-2cd9098cbfb4", { locale: 'pt-BR' });
  mp.checkout({
    preference: { id: preferenceId },
    render: { container: "#mp-checkout", label: "Concluir Pagamento" }
  });
}

// ===================== Fun√ß√£o desbloquear formul√°rio =====================
function desbloquearFormulario(formId){
  const form = document.getElementById(formId);
  form.querySelectorAll("input,textarea,button").forEach(el => el.disabled = false);
  statusDiv.textContent = "‚úÖ Formul√°rio desbloqueado ap√≥s pagamento!";
}
</script>

