<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Detalhes da Revisita</title>

<style>
body {
font-family: "Segoe UI", sans-serif;
margin: 0;
background-color: white;
}

  a {
    text-decoration: none;
  }

  .arrow {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-left: 3px solid #f2f2f2
    border-bottom: 3px solid #f2f2f2;
    margin-bottom: 10px;
    transform: rotate(45deg);
    position: absolute;
    top: 21px;
    left: 15px;


 }

  header {
    background-color: #2563eb;
    color: white;
    padding: 15px;
    border-radius: 0px;
    margin-bottom: 20px;
    text-align: center;
  }

  header .text {
    font-size: 1.5em;
    font-weight: bold;
  }

  #botoes-topo {
    display: flex;
    justify-content: absolute;
    gap: 10px;
    margin-bottom: 15px;
    margin-left: 20px;

 }

  #botoes-topo button {
    background-color: #3b82f6;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  #botoes-topo button:hover {
    background-color: #1e40af;
  }

  .card {
    background-color: white;
    border-radius: 0px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    padding: 20px;
  }

  .card h3 {
  margin-top: 0;
  color: black;
  font-size: 20px;
  border-bottom: 1.50px solid #ccc;
  margin-bottom: 40px;
}

  .card p {
    margin: 8px 0;
    font-size: 16px;
    margin-top: 30px;
}

  label {
  font-weight: bold;
  display: block;
  margin-top: 20px;
  margin-bottom: 5px;
  background: white;
 }

  input[type="text"],
  input[type="tel"] {
   width: 100%;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 14px;
  }

 
 #whatsContainer {
    margin-top: 20px;
  }

  #whatsContainer button {
    background-color: #22c55e;
    color: white;
    border: none;
    padding: 10px;
    margin-top: 10px;
    border-radius: 6px;
    cursor: pointer;
   font-weight: bolder;
   font-size: 15px;
}

  #whatsContainer button:hover {
    background-color: #15803d;
  }

  #mensagemStatus {
    margin-top: 20px;
    padding: 10px;
    text-align: center;
    border-radius: 8px;
    display: none;
    font-weight: bold;
    color: white;
    margin-left: 30px;
    margin-right: 30px;
 }

  #modalConfirmacao {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    justify-content: center;
    align-items: center;
    z-index: 999;
  }

  #modalConfirmacao .conteudo {
    background: white;
    padding: 25px;
    border-radius: 10px;
    text-align: center;
    width: 90%;
    max-width: 400px;
  }

  #modalConfirmacao .conteudo p {
    font-size: 16px;
    margin-bottom: 20px;
  }

  #modalConfirmacao .conteudo button {
    background-color: #ef4444;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    margin: 0 10px;
  }

  #modalConfirmacao .conteudo button#cancelarExclusao {
    background-color: #6b7280;
  }

  #modalConfirmacao .conteudo button:hover {
    opacity: 0.9;
  }

</style>

<a href="painel.html">
 <span class="arrow"></span>
 </a>
 </div>

  
 <header>
 <div class="text">Detalhes</div>
 </header>

<div id="botoes-topo">
  <button id="btnEditar">Editar</button>
  <button id="btnExcluir">Excluir</button>
</div>

<div class="card">
  <div class="detalhes" id="detalhes-revisita">Carregando...</div>

  <div id="whatsContainer" style="margin-top: 20px; display: none;">
    <label for="numeroWhatsApp">WhatsApp:</label>
    <input type="tel" id="numeroWhatsApp" placeholder="Ex: 95350376" />
  </div>
</div>

<div id="mensagemStatus"></div>

<div id="modalConfirmacao" style="display:none;">
  <div class="conteudo">
    <p>Tem certeza que deseja excluir esta Revisita?</p>
    <button id="confirmarExclusao">Sim</button>
    <button id="cancelarExclusao">Cancelar</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCqkWODpY54YGrvqPVMABK_k_ZJLo1KXMA",
    authDomain: "teste-cfe69.firebaseapp.com",
    projectId: "teste-cfe69",
    storageBucket: "teste-cfe69.appspot.com",
    messagingSenderId: "646579509123",
    appId: "1:646579509123:web:dd23b863dd8c54bca308b6",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore();

  const detalhes = document.getElementById('detalhes-revisita');
  const btnEditar = document.getElementById('btnEditar');
  const btnExcluir = document.getElementById('btnExcluir');
  const inputNumero = document.getElementById('numeroWhatsApp');
  const whatsContainer = document.getElementById("whatsContainer");
  const modal = document.getElementById("modalConfirmacao");
  const btnConfirmar = document.getElementById("confirmarExclusao");
  const btnCancelar = document.getElementById("cancelarExclusao");

  let revisitaId = null;
  let revisitaData = null;
  let editando = false;
  let btnWhats = null;
  let debounceTimeout;

  // Função para escapar HTML
  function escapeHtml(text = "") {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function mostrarMensagem(texto, cor = "#4caf50") {
    const mensagem = document.getElementById("mensagemStatus");
    mensagem.textContent = texto;
    mensagem.style.backgroundColor = cor;
    mensagem.style.display = "block";
    clearTimeout(mensagem.timeoutId);
    mensagem.timeoutId = setTimeout(() => {
      mensagem.style.display = "none";
    }, 3000);
  }

  function renderDetalhes(data) {
    detalhes.innerHTML = `
      <h3>${escapeHtml(data.nome || '')}</h3>
      <p><strong>Tema:</strong> ${escapeHtml(data.tema || '')}</p>
      <p><strong>Texto da bíblia:</strong> ${escapeHtml(data.textoBiblia || '')}</p>
      <p><strong>2ª Revisita:</strong> ${escapeHtml(data.segundaRevisita || '')}</p>
      <p><strong>Dia:</strong> ${escapeHtml(data.dia || '')}</p>
      <p><strong>Horário:</strong> ${escapeHtml(data.horario || '')}</p>
      <p><strong>Endereço:</strong> ${escapeHtml(data.endereco || '')}</p>
      <p><strong>Número da Casa:</strong> ${escapeHtml(data.casa || '')}</p>
    `;
    inputNumero.value = data.numero || '';
  }

  function renderEditForm(data) {
    detalhes.innerHTML = `
      <label for="inputNome">Nome:</label>
      <input type="text" id="inputNome" value="${escapeHtml(data.nome || '')}" />
      <label for="inputTema">Tema:</label>
      <input type="text" id="inputTema" value="${escapeHtml(data.tema || '')}" />
      <label for="inputTextoBiblia">Texto da bíblia:</label>
      <input type="text" id="inputTextoBiblia" value="${escapeHtml(data.textoBiblia || '')}" />
      <label for="inputSegundaRevisita">2ª Revisita:</label>
      <input type="text" id="inputSegundaRevisita" value="${escapeHtml(data.segundaRevisita || '')}" />
      <label for="inputDia">Dia:</label>
      <input type="text" id="inputDia" value="${escapeHtml(data.dia || '')}" />
      <label for="inputHorario">Horário:</label>
      <input type="time" id="inputHorario" maxlength="5" value="${escapeHtml(data.horario || '')}" />
      <label for="inputEndereco">Endereço:</label>
      <input type="text" id="inputEndereco" value="${escapeHtml(data.endereco || '')}" />
      <label for="inputCasa">Número da Casa:</label>
      <input type="text" id="inputCasa" value="${escapeHtml(data.casa || '')}" />
      <label for="inputNumeroWhatsApp">WhatsApp:</label>
      <input type="tel" id="inputNumeroWhatsApp" value="${escapeHtml(data.numero || '')}" />
    `;

    aplicarFormatacaoHorario();
  }

  // Validação simples do número WhatsApp (só dígitos, 8 a 15 caracteres)
  function validarNumeroWhatsApp(numero) {
    return /^\d{8,15}$/.test(numero);
  }

  btnEditar.addEventListener("click", async () => {
    if (!revisitaId || !revisitaData) return;

    if (!editando) {
      editando = true;
      btnEditar.textContent = "Salvar";
      whatsContainer.style.display = "none";
      renderEditForm(revisitaData);
    } else {
      const novoNome = document.getElementById('inputNome').value.trim();
      const novoTema = document.getElementById('inputTema').value.trim();
      const novoTextoBiblia = document.getElementById('inputTextoBiblia').value.trim();
      const novaSegundaRevisita = document.getElementById('inputSegundaRevisita').value.trim();
      const novoDia = document.getElementById('inputDia').value.trim();
      const novoHorario = document.getElementById('inputHorario').value.trim();
      const novoEndereco = document.getElementById('inputEndereco').value.trim();
      const novoCasa = document.getElementById('inputCasa').value.trim();
      const novoNumero = document.getElementById('inputNumeroWhatsApp').value.trim();

      if (!novoNome) {
        mostrarMensagem("Nome não pode ser vazio.", "#f44336");
        return;
      }
      if (novoNumero && !validarNumeroWhatsApp(novoNumero)) {
        mostrarMensagem("Número de WhatsApp inválido.", "#f44336");
        return;
      }

      try {
        await updateDoc(doc(db, 'revisita', revisitaId), {
          nome: novoNome,
          tema: novoTema,
          textoBiblia: novoTextoBiblia,
          segundaRevisita: novaSegundaRevisita,
          dia: novoDia,
          horario: novoHorario,
          endereco: novoEndereco,
          casa: novoCasa,
          numero: novoNumero
        });

        revisitaData = {
          nome: novoNome,
          tema: novoTema,
          textoBiblia: novoTextoBiblia,
          segundaRevisita: novaSegundaRevisita,
          dia: novoDia,
          horario: novoHorario,
          endereco: novoEndereco,
          casa: novoCasa,
          numero: novoNumero
        };

        editando = false;
        btnEditar.textContent = "Editar";
        renderDetalhes(revisitaData);
        whatsContainer.style.display = "block";
        mostrarMensagem("Dados atualizados com sucesso!");
      } catch (error) {
        console.error("Erro ao atualizar:", error);
        mostrarMensagem("Erro ao salvar alterações.", "#f44336");
      }
    }
  });

  btnExcluir.addEventListener("click", () => {
    if (!revisitaId) return;
    modal.style.display = "flex";
  });

  btnConfirmar.addEventListener("click", async () => {
    try {
      await deleteDoc(doc(db, 'revisita', revisitaId));
      revisitaData = null;
      detalhes.innerHTML = "<p>Revisita excluída.</p>";
      btnEditar.disabled = true;
      btnExcluir.disabled = true;
      inputNumero.value = "";
      whatsContainer.style.display = "none";
      if (btnWhats) btnWhats.remove();
      localStorage.removeItem('revisitaSelecionado');
      mostrarMensagem("Revisita excluída com sucesso.");
    } catch (error) {
      console.error("Erro ao excluir:", error);
      mostrarMensagem("Erro ao excluir revisita.", "#f44336");
    }
    modal.style.display = "none";
  });

  btnCancelar.addEventListener("click", () => {
    modal.style.display = "none";
  });

  function conversarNoWhatsApp() {
    const numero = inputNumero.value.trim();
    if (!numero) {
      mostrarMensagem("Por favor, insira o número da revisita.", "#f44336");
      return;
    }
    if (!validarNumeroWhatsApp(numero)) {
      mostrarMensagem("Número de WhatsApp inválido.", "#f44336");
      return;
    }
    const mensagem = encodeURIComponent(`Olá ${revisitaData.nome}, tudo bem?`);
    const link = `https://wa.me/${numero}?text=${mensagem}`;
    window.open(link, "_blank");
  }

  async function carregarRevisitaSelecionada() {
    const revisita = JSON.parse(localStorage.getItem('revisitaSelecionado'));

    if (!revisita || !revisita.id) {
      detalhes.innerHTML = "<p>Revisita não encontrada.</p>";
      return;
    }

    try {
      const docRef = doc(db, "revisita", revisita.id);
      const docSnap = await getDoc(docRef);

      if (!docSnap.exists()) {
        detalhes.innerHTML = "<p>Revisita não encontrada no banco de dados.</p>";
        return;
      }

      revisitaId = docSnap.id;
      revisitaData = docSnap.data();

      renderDetalhes(revisitaData);
      whatsContainer.style.display = "block";

      if (!btnWhats) {
        btnWhats = document.createElement("button");
        btnWhats.textContent = "Conversar no WhatsApp";
        btnWhats.style.marginTop = "10px";
        btnWhats.style.display = "block";
        inputNumero.insertAdjacentElement("afterend", btnWhats);
        btnWhats.addEventListener("click", conversarNoWhatsApp);
      }

      inputNumero.addEventListener("input", () => {
        if (!revisitaId) return;
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(async () => {
          const novoNumero = inputNumero.value.trim();
          if (novoNumero && !validarNumeroWhatsApp(novoNumero)) {
            mostrarMensagem("Número de WhatsApp inválido.", "#f44336");
            return;
          }
          try {
            await updateDoc(doc(db, 'revisita', revisitaId), { numero: novoNumero });
            revisitaData.numero = novoNumero;
            mostrarMensagem("Número do WhatsApp salvo!");
          } catch (error) {
            console.error("Erro ao salvar número:", error);
            mostrarMensagem("Erro ao salvar número.", "#f44336");
          }
        }, 1000); // debounce 1s
      });

    } catch (error) {
      detalhes.innerHTML = "<p>Erro ao carregar revisita.</p>";
      console.error("Erro ao carregar revisita:", error);
    }
  }

  carregarRevisitaSelecionada();

  // Função para formatar horário no input
  function aplicarFormatacaoHorario() {
    const inputHorario = document.getElementById("inputHorario");
    if (!inputHorario) return;

    inputHorario.addEventListener("input", function () {
      let valor = this.value.replace(/\D/g, ""); // Remove tudo que não for número

      if (valor.length >= 3) {
        valor = valor.slice(0, 4); // máximo 4 dígitos
        let horas = parseInt(valor.slice(0, 2), 10);
        let minutos = parseInt(valor.slice(2), 10);

        if (horas > 23) horas = 23;
        if (minutos > 59) minutos = 59;

        const h = horas.toString().padStart(2, '0');
        const m = minutos.toString().padStart(2, '0');

        this.value = `${h}:${m}`;
      } else {
        this.value = valor;
      }
    });
  }
</script>


